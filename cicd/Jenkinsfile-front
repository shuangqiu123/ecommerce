pipeline {
	agent {
		docker {
			image 'node:12.19.0'
		}
	}
	environment {
		DIST_PATH = '/var/lib/jenkins/workspace/demostore-frontend/frontend/dist'
	}
	stages {
		stage('Installing dependencies') {
			steps {
				dir('./frontend') {
					echo "Installing dependencies in package.json"
					sh 'npm cache clean --force'
					sh 'npm install'
				}
			}
		}

		stage('Build dist files') {
			steps {
				dir('./frontend') {
					sh 'npm run build'
				}
			}
		}

		stage('Installing AWS CLI') {
			steps {
				echo "Installing AWS CLI"
				sh 'apt-get update'
				sh 'apt install python3-pip -y'
				sh 'pip3 install awscli --upgrade'
			}
		}

		stage('Deploying static dist files to S3') {
			steps {
				echo 'deploying to S3'
				withAWS(credentials: 'aws-credentials', region: 'ap-southeast-2') {
					sh 'aws s3 rm "${BUCKET}"'
					sh 'aws s3 cp "${DIST_PATH}" "${BUCKET}" --recursive --acl public-read'
				}
			}
		}
	}
}